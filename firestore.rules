rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // S4 SECURITY FIX - REMOVED TEMPORARY OPEN RULE
    // Previous: allow read, write: if true; ‚Üê DANGEROUS!
    // Now: Specific rules for each collection with role-based access
    // ============================================================================

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role;
    }

    function isEmployee() {
      return isAuthenticated() && 
        getUserRole() in ['user', 'manager', 'admin', 'masterAdmin'];
    }

    function isAdmin() {
      return isAuthenticated() && 
        getUserRole() in ['admin', 'masterAdmin'];
    }

    // ============================================================================
    // USER PROFILES - Everyone can read their own, only admins can modify
    // ============================================================================
    match /userProfiles/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||  // Own profile
        isEmployee()  // Or employee
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||  // Own updates
        isAdmin()  // Or admin changing roles
      );
      allow delete: if isAuthenticated() && isAdmin();
    }

    // Legacy users collection (if still used)
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isEmployee()
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin()
      );
      allow delete: if isAuthenticated() && isAdmin();
    }

    // ============================================================================
    // CONTACTS - S4 FIX: Clients can ONLY see their own contact record
    // ============================================================================
    match /contacts/{contactId} {
      allow read: if isAuthenticated() && (
        isEmployee() ||  // Employees see all
        resource.data.uid == request.auth.uid  // Clients see only theirs
      );
      allow create: if isAuthenticated();  // Anyone can create (enrollment)
      allow update: if isAuthenticated() && (
        isEmployee() ||  // Employees can update
        resource.data.uid == request.auth.uid  // Clients can update own
      );
      allow delete: if isAuthenticated() && isAdmin();

      // Subcollections (credit reports, documents, etc.)
      match /creditReports/{reportId} {
        allow read: if isAuthenticated() && (
          isEmployee() ||
          get(/databases/$(database)/documents/contacts/$(contactId)).data.uid == request.auth.uid
        );
        allow write: if isAuthenticated() && isEmployee();
      }

      match /documents/{docId} {
        allow read: if isAuthenticated() && (
          isEmployee() ||
          get(/databases/$(database)/documents/contacts/$(contactId)).data.uid == request.auth.uid
        );
        allow write: if isAuthenticated() && (
          isEmployee() ||
          get(/databases/$(database)/documents/contacts/$(contactId)).data.uid == request.auth.uid
        );
      }
    }

    // ============================================================================
    // INVOICES, TASKS, ANALYTICS - S4 FIX: Staff only or own data
    // ============================================================================
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.contactId == request.auth.uid
      );
      allow create, update: if isAuthenticated() && isEmployee();
      allow delete: if isAuthenticated() && isAdmin();
    }

    match /tasks/{taskId} {
      allow read, write: if isAuthenticated() && isEmployee();  // Staff only
    }

    match /revenue/{revenueId} {
      allow read: if isAuthenticated() && isEmployee();
      allow write: if false;  // Cloud functions only
    }

    match /analytics/{analyticsId} {
      allow read: if isAuthenticated() && isEmployee();
      allow write: if false;
    }

    match /staffNotifications/{notificationId} {
      allow read: if isAuthenticated() && isEmployee();
      allow create: if false;
      allow update: if isAuthenticated() && isEmployee();
      allow delete: if isAuthenticated() && isAdmin();
    }

    // ============================================================================
    // IDIQ, DISPUTES, PAYMENTS - Clients can see own data
    // ============================================================================
    match /idiqEnrollments/{enrollmentId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.clientId == request.auth.uid
      );
      allow create: if isAuthenticated() && isEmployee();
      allow update, delete: if isAuthenticated() && isAdmin();
    }

    match /creditReports/{reportId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.clientId == request.auth.uid
      );
      allow create, update: if isAuthenticated() && isEmployee();
      allow delete: if isAuthenticated() && isAdmin();
    }

    match /disputes/{disputeId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.clientId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isEmployee();
    }

    match /paymentMethods/{methodId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.clientId == request.auth.uid
      );
      allow create, update: if isAuthenticated() && (
        isEmployee() || request.resource.data.clientId == request.auth.uid
      );
      allow delete: if isAuthenticated() && isAdmin();
    }

    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.clientId == request.auth.uid
      );
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && (
        isEmployee() || resource.data.clientId == request.auth.uid
      );
      allow delete: if isAuthenticated() && isAdmin();
    }

    match /contracts/{contractId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.contactId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        isEmployee() || resource.data.contactId == request.auth.uid
      );
      allow delete: if isAuthenticated() && isAdmin();
    }

    match /contractSigningTokens/{tokenId} {
      allow read: if true;  // Public signing links
      allow create: if isAuthenticated() && isEmployee();
      allow update: if true;
      allow delete: if isAuthenticated() && isAdmin();
    }

    // ============================================================================
    // TAX SERVICES (clients can see own data)
    // ============================================================================
    match /taxReturns/{returnId} {
      allow read: if isAuthenticated() && (
        isEmployee() || resource.data.userId == request.auth.uid
      );
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated() && isAdmin();
    }

    match /taxDocuments/{documentId} {
      allow read, create, update: if isAuthenticated() && (
        isEmployee() || resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && isAdmin();
    }

    match /activityLogs/{logId} {
      allow read: if isAuthenticated() && isEmployee();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    match /emailLogs/{logId} {
      allow read: if isAuthenticated() && isEmployee();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isEmployee();
      allow delete: if isAuthenticated() && isAdmin();
    }
  }
}