# üìß SendGrid Setup Guide for SpeedyCRM

Complete step-by-step guide to configure SendGrid for email automation.

---

## üéØ Overview

SendGrid will handle all email delivery for your automated workflows. This guide will walk you through:
1. Creating a SendGrid account
2. Configuring domain authentication
3. Getting your API key
4. Setting up webhooks
5. Testing your configuration

---

## üìù Step 1: Create SendGrid Account

1. **Go to SendGrid:** https://signup.sendgrid.com/
2. **Choose Plan:**
   - Start with **Free Tier** (100 emails/day)
   - Upgrade to **Essentials** when ready ($14.95/month for 50K emails)
3. **Complete Registration:**
   - Enter business email (chris@speedycreditrepair.com)
   - Verify email address
   - Complete profile setup

---

## üîê Step 2: Get Your API Key

1. **Navigate to Settings:**
   - Click **Settings** ‚Üí **API Keys** in left sidebar
   
2. **Create New API Key:**
   - Click **Create API Key**
   - Name: `SpeedyCRM-Production`
   - Permissions: **Full Access**
   - Click **Create & View**

3. **Save Your API Key:**
   ```
   IMPORTANT: Copy this key NOW - you won't see it again!
   
   Format: SG.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

4. **Add to Firebase Environment:**
   ```bash
   cd functions
   firebase functions:config:set sendgrid.api_key="YOUR_API_KEY_HERE"
   ```

5. **Add to functions/.env (for local testing):**
   ```
   SENDGRID_API_KEY=SG.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

---

## üåê Step 3: Domain Authentication (CRITICAL!)

Domain authentication prevents emails from going to spam.

### 3.1 Start Authentication Process

1. **Navigate:** Settings ‚Üí Sender Authentication ‚Üí Authenticate Your Domain
2. **Choose:** "I use a DNS provider" (your domain host)
3. **Enter Domain:** speedycreditrepair.com
4. **Advanced Settings:**
   - Use default subdomain (em1234.speedycreditrepair.com)
   - Check "Would you also like to brand the links in your emails?"

### 3.2 DNS Records

SendGrid will provide DNS records. Add these to your domain host:

**Example Records (yours will be different):**
```
Type    Host                Value
CNAME   em1234              u12345.wl123.sendgrid.net
CNAME   s1._domainkey       s1.domainkey.u12345.wl123.sendgrid.net
CNAME   s2._domainkey       s2.domainkey.u12345.wl123.sendgrid.net
```

**Where to add these:**
- **GoDaddy:** DNS Management ‚Üí Add Records
- **Namecheap:** Domain List ‚Üí Manage ‚Üí Advanced DNS
- **Cloudflare:** DNS ‚Üí Add Record

### 3.3 Verify Authentication

1. **Wait:** 24-48 hours for DNS propagation (usually faster)
2. **Verify:** SendGrid will show ‚úì when complete
3. **Test:** Send a test email to verify

---

## üé£ Step 4: Setup Webhooks

Webhooks track email opens, clicks, bounces, etc.

### 4.1 Configure in SendGrid

1. **Navigate:** Settings ‚Üí Mail Settings ‚Üí Event Webhook
2. **Enable:** Toggle ON
3. **HTTP POST URL:**
   ```
   https://us-central1-YOUR-PROJECT-ID.cloudfunctions.net/handleSendGridWebhook
   ```
   *Replace YOUR-PROJECT-ID with your Firebase project ID*

4. **Select Actions to Post:**
   - ‚úì Delivered
   - ‚úì Opened
   - ‚úì Clicked
   - ‚úì Bounced
   - ‚úì Dropped
   - ‚úì Spam Report
   - ‚úì Unsubscribe

5. **Test Your Integration:**
   - Click "Test Your Integration"
   - Should receive 200 OK response

---

## üîß Step 5: Configure Firebase Functions

### 5.1 Environment Variables

Add these to your Firebase config:

```bash
cd functions
firebase functions:config:set \
  sendgrid.api_key="SG.xxxxx..." \
  email.from_email="chris@speedycreditrepair.com" \
  email.from_name="Chris Lahage - Speedy Credit Repair" \
  email.reply_to="chris@speedycreditrepair.com"
```

### 5.2 Deploy Functions

```bash
cd functions
npm install @sendgrid/mail
firebase deploy --only functions
```

---

## ‚úÖ Step 6: Test Your Setup

### 6.1 Send Test Email

```javascript
// In Firebase Console ‚Üí Functions ‚Üí Run function
// Function: manualSendEmail
// Parameters:
{
  "contactId": "test-contact-id",
  "emailType": "welcome"
}
```

### 6.2 Check Results

1. **Email Delivery:** Check inbox
2. **SendGrid Dashboard:** Activity ‚Üí View stats
3. **Firebase Logs:** Functions ‚Üí Logs
4. **Firestore:** Check `emailEvents` collection

---

## üö® Troubleshooting

### Problem: Emails Going to Spam

**Solution:**
1. Verify domain authentication is complete (all ‚úì green)
2. Add SPF record to DNS:
   ```
   TXT  @  v=spf1 include:sendgrid.net ~all
   ```
3. Warm up your domain (start with small volumes)
4. Avoid spam trigger words in content

### Problem: Webhooks Not Working

**Solution:**
1. Verify function URL is correct (check Firebase Console)
2. Check function logs for errors
3. Ensure function is deployed: `firebase deploy --only functions`
4. Test webhook manually with SendGrid's test feature

### Problem: API Key Not Working

**Solution:**
1. Regenerate API key in SendGrid
2. Update Firebase config
3. Redeploy functions

---

## üìä Monitoring & Best Practices

### Daily Checks

- **SendGrid Dashboard:** Monitor delivery rates
- **Firebase Logs:** Check for errors
- **Firestore Collections:**
  - `emailEvents` - Track engagement
  - `errorLogs` - Monitor failures

### Rate Limits

- **Free Tier:** 100 emails/day
- **Essentials:** 50,000 emails/month
- **Scale carefully** to avoid hitting limits

### Email Reputation

- Keep bounce rate < 5%
- Keep spam complaint rate < 0.1%
- Monitor unsubscribe rate
- Remove invalid addresses immediately

---

## üìû Support

**SendGrid Support:**
- Docs: https://docs.sendgrid.com/
- Support: https://support.sendgrid.com/

**Firebase Support:**
- Docs: https://firebase.google.com/docs/functions
- Console: https://console.firebase.google.com/

---

## ‚ú® You're Ready!

Once all steps are complete, your automated email system will:
- ‚úÖ Send personalized emails automatically
- ‚úÖ Track opens and clicks in real-time
- ‚úÖ Progress contacts through workflows
- ‚úÖ Scale to thousands of emails per day

**Next:** Run through the EMAIL_SYSTEM_DEPLOYMENT.md guide to deploy everything!

---

*Last Updated: October 2025*