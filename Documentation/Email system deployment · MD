# ğŸš€ Email System Deployment Guide

Complete deployment instructions for SpeedyCRM Email Automation System.

---

## ğŸ“‹ Prerequisites

Before deploying, ensure you have:
- âœ… Firebase project set up
- âœ… Node.js installed (v16 or higher)
- âœ… Firebase CLI installed (`npm install -g firebase-tools`)
- âœ… SendGrid account configured (see SENDGRID_SETUP_GUIDE.md)
- âœ… All email system files downloaded

---

## ğŸ“ Step 1: Organize Your Files

### 1.1 File Structure

Your project should look like this:

```
C:\SCR Project\my-clever-crm\
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ aiEmailService.js               â† Place here
â”‚   â”œâ”€â”€ idiqApplicationTracker.js       â† Place here
â”‚   â”œâ”€â”€ sendGridService.js              â† Place here
â”‚   â”œâ”€â”€ emailSequences.js               â† Place here
â”‚   â”œâ”€â”€ emailWorkflowEngine.js          â† Place here
â”‚   â”œâ”€â”€ emailBrandingConfig.js          â† Place here
â”‚   â”œâ”€â”€ emailFunctions.js               â† Place here
â”‚   â”œâ”€â”€ index.js                        â† Update this
â”‚   â””â”€â”€ package.json                    â† Update this
â”‚
â”œâ”€â”€ src/
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ EmailWorkflowDashboard.jsx  â† Place here
â”‚
â””â”€â”€ email-templates/                    â† Create this folder
    â”œâ”€â”€ base-template.html
    â”œâ”€â”€ welcome-email.html
    â”œâ”€â”€ reminder-email.html
    â”œâ”€â”€ help-email.html
    â”œâ”€â”€ report-ready-email.html
    â””â”€â”€ consultation-email.html
```

### 1.2 Copy Files

```bash
# Navigate to your project
cd C:\SCR Project\my-clever-crm

# Create email-templates folder
mkdir email-templates

# Copy all files to their locations (do this manually or use commands)
```

---

## ğŸ“¦ Step 2: Install Dependencies

### 2.1 Functions Dependencies

```bash
cd functions
npm install --save @sendgrid/mail openai puppeteer
```

### 2.2 Update package.json

Your `functions/package.json` should include:

```json
{
  "dependencies": {
    "firebase-admin": "^11.0.0",
    "firebase-functions": "^4.0.0",
    "@sendgrid/mail": "^7.7.0",
    "openai": "^4.20.0",
    "puppeteer": "^21.5.0"
  }
}
```

---

## âš™ï¸ Step 3: Configure Environment Variables

### 3.1 Firebase Config

```bash
cd functions

# SendGrid
firebase functions:config:set \
  sendgrid.api_key="YOUR_SENDGRID_API_KEY"

# Email Settings
firebase functions:config:set \
  email.from_email="chris@speedycreditrepair.com" \
  email.from_name="Chris Lahage - Speedy Credit Repair" \
  email.reply_to="chris@speedycreditrepair.com"

# OpenAI (already configured)
firebase functions:config:set \
  openai.api_key="YOUR_OPENAI_KEY"

# IDIQ (already configured)
firebase functions:config:set \
  idiq.partner_id="11981" \
  idiq.partner_secret="YOUR_SECRET"

# IDIQ Dashboard (optional - for backup checking)
firebase functions:config:set \
  idiq.dashboard_email="YOUR_IDIQ_EMAIL" \
  idiq.dashboard_password="YOUR_IDIQ_PASSWORD"
```

### 3.2 Local Testing (.env file)

Create `functions/.env` for local testing:

```env
SENDGRID_API_KEY=SG.xxxxx
FROM_EMAIL=chris@speedycreditrepair.com
FROM_NAME=Chris Lahage - Speedy Credit Repair
REPLY_TO_EMAIL=chris@speedycreditrepair.com

OPENAI_API_KEY=sk-xxxxx
IDIQ_PARTNER_ID=11981
IDIQ_PARTNER_SECRET=xxxxx

IDIQ_DASHBOARD_EMAIL=xxxxx
IDIQ_DASHBOARD_PASSWORD=xxxxx
```

---

## ğŸ”„ Step 4: Update index.js

### 4.1 Add Email Functions Export

In `functions/index.js`, add these lines:

```javascript
// Import email functions
const emailFunctions = require('./emailFunctions');

// Export all email functions
exports.onContactCreated = emailFunctions.onContactCreated;
exports.processScheduledStages = emailFunctions.processScheduledStages;
exports.handleSendGridWebhook = emailFunctions.handleSendGridWebhook;
exports.manualSendEmail = emailFunctions.manualSendEmail;
exports.pauseWorkflow = emailFunctions.pauseWorkflow;
exports.resumeWorkflow = emailFunctions.resumeWorkflow;
exports.checkIDIQApplications = emailFunctions.checkIDIQApplications;
exports.generateAIEmailContent = emailFunctions.generateAIEmailContent;
```

---

## ğŸš€ Step 5: Deploy to Firebase

### 5.1 Test Locally (Optional)

```bash
cd functions
npm run serve
```

### 5.2 Deploy Functions

```bash
firebase deploy --only functions
```

This will deploy:
- onContactCreated (trigger)
- processScheduledStages (cron)
- handleSendGridWebhook (HTTP)
- manualSendEmail (callable)
- pauseWorkflow (callable)
- resumeWorkflow (callable)
- checkIDIQApplications (cron)
- generateAIEmailContent (callable)

**Expected Output:**
```
âœ”  functions[onContactCreated]: Successful create operation.
âœ”  functions[processScheduledStages]: Successful create operation.
... (more functions)
âœ”  Deploy complete!
```

---

## ğŸ¨ Step 6: Deploy Frontend

### 6.1 Build React App

```bash
cd C:\SCR Project\my-clever-crm
npm run build
```

### 6.2 Deploy to Firebase Hosting

```bash
firebase deploy --only hosting
```

---

## âœ… Step 7: Testing & Verification

### 7.1 Test New Contact Creation

1. **Create test contact in Firestore:**
   - Collection: `contacts`
   - Fields:
     ```json
     {
       "name": "Test User",
       "email": "test@example.com",
       "phone": "555-1234",
       "source": "ai-receptionist"
     }
     ```

2. **Check Firebase Functions Logs:**
   - Should see "Workflow ai-receptionist started"
   - Should see "Email sent successfully"

3. **Check Email:**
   - Should receive welcome email
   - Check SendGrid dashboard for delivery confirmation

### 7.2 Test Webhook Processing

1. **Send a test email**
2. **Open the email**
3. **Check Firestore:**
   - Collection: `emailEvents`
   - Should show "open" event

### 7.3 Test Manual Send

1. **Open Firebase Console**
2. **Go to Functions**
3. **Run `manualSendEmail`:**
   ```json
   {
     "contactId": "test-contact-id",
     "emailType": "welcome"
   }
   ```
4. **Verify email received**

### 7.4 Test Dashboard

1. **Navigate to:** https://myclevercrm.com/email-workflows
2. **Verify:**
   - Statistics load correctly
   - Contacts table shows data
   - Actions work (pause/resume/send)

---

## ğŸ“Š Step 8: Monitor System

### 8.1 What to Monitor

**Firebase Functions Logs:**
```bash
firebase functions:log
```

**SendGrid Dashboard:**
- Activity Feed
- Statistics
- Delivery rates
- Bounce rates

**Firestore Collections:**
- `contacts` - Contact data and workflow states
- `emailEvents` - Engagement tracking
- `scheduledStages` - Pending stages
- `errorLogs` - System errors

### 8.2 Set Up Alerts

**Firebase Alerts:**
- Functions â†’ Alerts
- Set up alerts for:
  - Function errors
  - Quota exceeded
  - Slow functions

**SendGrid Alerts:**
- Settings â†’ Mail Settings â†’ Activity Feed
- Enable email notifications for:
  - High bounce rates
  - High spam rates
  - API errors

---

## ğŸ”§ Troubleshooting

### Functions Not Deploying

**Problem:** `Error: HTTP Error: 403, Permission denied`

**Solution:**
```bash
firebase login --reauth
firebase use --add
firebase deploy --only functions
```

### Emails Not Sending

**Check List:**
1. âœ“ SendGrid API key configured correctly
2. âœ“ Domain authentication complete
3. âœ“ Functions deployed successfully
4. âœ“ Contact has valid email address
5. âœ“ Check function logs for errors

### Webhooks Not Working

**Check List:**
1. âœ“ Webhook URL is correct in SendGrid
2. âœ“ `handleSendGridWebhook` function deployed
3. âœ“ Function allows unauthenticated access
4. âœ“ Test webhook in SendGrid dashboard

### Dashboard Not Loading

**Check List:**
1. âœ“ Component file in correct location
2. âœ“ Route configured in App.js
3. âœ“ Firebase SDK initialized
4. âœ“ User has admin role

---

## ğŸ¯ Post-Deployment Checklist

After deployment, verify:

- [ ] All 8 functions deployed successfully
- [ ] Environment variables configured
- [ ] SendGrid domain authenticated
- [ ] Webhooks receiving events
- [ ] Test contact created workflow successfully
- [ ] Email received and tracked
- [ ] Dashboard accessible and functional
- [ ] Manual send working
- [ ] Pause/resume working
- [ ] Scheduled jobs running (check after 1 hour)
- [ ] IDIQ checker running (check next day at 9 AM)

---

## ğŸ“ˆ Scaling Considerations

### When to Upgrade SendGrid

**Free Tier (100 emails/day):**
- Good for: Testing, 20-30 contacts

**Essentials ($14.95/month - 50K emails/month):**
- Good for: 100-500 active contacts
- Upgrade when: Hitting daily limit regularly

**Pro ($89.95/month - 1.5M emails/month):**
- Good for: 1000+ active contacts
- Upgrade when: Need dedicated IP, advanced features

### Firebase Costs

**Functions:**
- Free tier: 2M invocations/month
- Typical cost: $0-5/month for small volume
- Scale cost: $20-50/month for high volume

**Firestore:**
- Free tier: 50K reads, 20K writes per day
- Typical cost: $0-10/month
- Monitor: Check Firebase Console â†’ Usage

---

## ğŸ‰ Success!

Your email automation system is now live! 

**What's happening automatically:**
1. New contacts trigger workflows
2. Emails send on schedule
3. Engagement tracked in real-time
4. IDIQ applications monitored
5. Workflows progress based on behavior

**Next Steps:**
1. Monitor for 24-48 hours
2. Adjust timing/content as needed
3. Add more contacts
4. Scale up SendGrid plan when ready

---

## ğŸ“ Need Help?

**Firebase Support:**
- Console: https://console.firebase.google.com/
- Docs: https://firebase.google.com/docs

**SendGrid Support:**
- Dashboard: https://app.sendgrid.com/
- Docs: https://docs.sendgrid.com/

**System Logs:**
```bash
# View function logs
firebase functions:log --only emailFunctions

# View specific function
firebase functions:log --only onContactCreated
```

---

*Last Updated: October 2025*  
*SpeedyCRM Email Automation System v1.0*